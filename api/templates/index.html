<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KO Reconciliation Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 50px; }
    input, button, label { margin: 10px 0; display: block; }
    button { padding: 10px 20px; background-color: #0078D7; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:disabled { background-color: #ccc; }
  </style>
</head>
<body>
  <h2>Upload Reconciliation Files</h2>
  <form id="uploadForm">
    <label>Admin File:</label>
    <input type="file" id="admin_file" name="admin_file" required>

    <label>E-Cheque File:</label>
    <input type="file" id="echeque_file" name="echeque_file" required>

    <label>YONO File:</label>
    <input type="file" id="yono_file" name="yono_file" required>

    <label>Date:</label>
    <input type="date" id="selected_date" name="selected_date" required>

    <button type="button" id="submitBtn" onclick="compressAndUpload()">Upload & Process</button>
  </form>

  <p id="status"></p>

  <script>
    async function compressAndUpload() {
      const admin = document.getElementById("admin_file").files[0];
      const echeque = document.getElementById("echeque_file").files[0];
      const yono = document.getElementById("yono_file").files[0];
      const date = document.getElementById("selected_date").value;

      if (!admin || !echeque || !yono || !date) {
        alert("Please upload all files and select a date.");
        return;
      }

      document.getElementById("submitBtn").disabled = true;
      document.getElementById("status").textContent = "Compressing files...";

      const zip = new JSZip();
      zip.file(admin.name, admin);
      zip.file(echeque.name, echeque);
      zip.file(yono.name, yono);

      const zipped = await zip.generateAsync({ type: "blob", compression: "DEFLATE" });

      const formData = new FormData();
      formData.append("zip_file", zipped, "recon_files.zip");
      formData.append("selected_date", date);

      document.getElementById("status").textContent = "Uploading to server...";

      const response = await fetch("/process", {
        method: "POST",
        body: formData
      });

      if (response.redirected) {
        window.location.href = response.url;
      } else {
        document.getElementById("status").textContent = "Error: " + (await response.text());
      }
    }
  </script>
</body>
</html>
